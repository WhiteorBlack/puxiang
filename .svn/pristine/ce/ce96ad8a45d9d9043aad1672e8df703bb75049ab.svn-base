package com.puxiang.mall.module.classify.viewmodel;

import android.app.Activity;
import android.databinding.BaseObservable;
import android.databinding.Bindable;
import android.databinding.BindingAdapter;
import android.util.Log;
import android.view.View;

import com.facebook.drawee.view.SimpleDraweeView;
import com.puxiang.mall.BR;
import com.puxiang.mall.MyApplication;
import com.puxiang.mall.R;
import com.puxiang.mall.config.CacheKey;
import com.puxiang.mall.fragment.BaseBindFragment;
import com.puxiang.mall.model.data.RxAds;
import com.puxiang.mall.mvvm.base.ViewModel;
import com.puxiang.mall.network.NetworkSubscriber;
import com.puxiang.mall.network.retrofit.ApiWrapper;
import com.puxiang.mall.network.retrofit.RetrofitUtil;
import com.puxiang.mall.utils.ActivityUtil;
import com.puxiang.mall.widget.MyBanner;
import com.orhanobut.logger.Logger;
import com.trello.rxlifecycle2.android.FragmentEvent;

import java.util.ArrayList;
import java.util.List;

import cn.bingoogolapple.bgabanner.BGABanner;

/**
 * Created by 123 on 2017/9/5.
 */

public class HeadBannerViewModel extends BaseObservable implements ViewModel, BGABanner.Delegate<View, RxAds>, BGABanner.Adapter {
    private Activity activity;
    private BaseBindFragment fragment;
    public List<RxAds> bannerList = new ArrayList<>();

    public HeadBannerViewModel(BaseBindFragment fragment) {
        this.fragment = fragment;
        this.activity = fragment.getActivity();
    }

    @Override
    public void destroy() {

    }

    @Override
    public void fillBannerItem(BGABanner banner, View itemView, Object model, int position) {
        ((SimpleDraweeView) itemView).setImageURI(((RxAds) model).getPicUrl());
        Logger.e("fillBannerItem");
    }

    @BindingAdapter("headBanner")
    public static void setBanner(MyBanner banner, List<RxAds> list) {
        Log.e("2222", "setBannerList: " + list.size());
        if (list == null || list.size() < 1) {
            return;
        }

        List<String> tips = new ArrayList<>();
        for (RxAds ads : list) {
            tips.add(ads.getText());
        }
        banner.setData(R.layout.viewpager_img, list, tips);
    }

    /**
     * 获取轮播图数据
     */
    public void getBannerData(String channelCode) {
        ApiWrapper.getInstance()
                .getAds(channelCode)
                .compose(fragment.bindUntilEvent(FragmentEvent.DESTROY))
                .subscribe(new NetworkSubscriber<List<RxAds>>() {
                    @Override
                    public void onFail(RetrofitUtil.APIException e) {
                        super.onFail(e);
                    }

                    @Override
                    public void onSuccess(List<RxAds> bean) {
                        MyApplication.mCache.put(CacheKey.MALL_BANNER, bean);
                        bannerList.clear();
                        bannerList.addAll(bean);
                        notifyPropertyChanged(BR.headBanner);
                    }
                });
    }

    @Bindable
    public List<RxAds> getHeadBanner() {
        return bannerList;
    }

    @Override
    public void onBannerItemClick(BGABanner banner, View itemView, RxAds model, int position) {
        try {
            ActivityUtil.startLink(activity, model);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
